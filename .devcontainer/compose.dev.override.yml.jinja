# =============================================================================
# DevContainer Compose Override
# =============================================================================
# This file OVERRIDES services from compose.base.yml for DevContainer use.
# It is ONLY loaded when VSCode starts the DevContainer (via devcontainer.json).
#
# Key differences from release stages:
# - Extra volume mounts: apps (live editing), vscode-host (keybindings)
# - DEV_CONTAINER=1 environment variable
# - app service runs "sleep infinity" (Procfile handles actual services)
#
# When you run "bench ops stage run dev", this file is NOT loaded,
# so the "normal" init from compose.init.migrate.yml is used (sites volume only).
# =============================================================================

# -----------------------------------------------------------------------------
# YAML Anchor: backend_defaults
# -----------------------------------------------------------------------------
# This anchor defines shared settings for DevContainer services.
# Services using "<<: *backend_defaults" INHERIT these volumes and env_file.
#
# The "init" service below uses this anchor, which means it gets:
# - apps volume (for live code editing in DevContainer)
# - vscode-host bind mount (for keybindings sync)
# - env_file pointing to .env.dev
#
# This REPLACES the init service from compose.init.migrate.yml when this
# override file is loaded. The release init (sites volume only) is not used
# in DevContainer context - and that's intentional!
# -----------------------------------------------------------------------------
x-backend-defaults: &backend_defaults
  image: "${IQ_IMAGE}:${IQ_IMAGE_TAG}"
  platform: linux/amd64
  volumes:
    - sites:/home/{{ image_user }}/bench/sites
    - apps:/home/{{ image_user }}/bench/apps          # DevContainer: live code editing
    - type: bind
      source: "${VSCODE_SETTINGS_PATH}"
      target: "/home/{{ image_user }}/.vscode-host"   # DevContainer: keybindings sync
  env_file:
    - ../env/.env
    - ../env/.env.dev

services:
  # ---------------------------------------------------------------------------
  # init: Site initialization (OVERRIDES compose.init.migrate.yml)
  # ---------------------------------------------------------------------------
  # This init service REPLACES the one from compose.init.migrate.yml when
  # compose.dev.override.yml is loaded. Key differences:
  # - Uses backend_defaults anchor → gets apps + vscode-host volumes
  # - DEV_CONTAINER=1 via environment → init_site.sh knows it's in DevContainer
  #
  # No {{ app_name }} bind mount here! The init service uses the image's apps
  # (with node_modules already built). The bind mount in the app service
  # (devcontainer.json) is for live editing only.
  #
  # No depends_on here - init_site.sh uses wait-for-it to check DB/Redis
  # availability (works for both container and external services).
  # ---------------------------------------------------------------------------
  init:
    <<: *backend_defaults
    user: "0"  # Root needed to fix volume ownership for HOST_UID != 1000
    # No {{ app_name }} bind mount here! Init uses the image's apps (with node_modules).
    environment:
      DEV_CONTAINER: "1"

  app:
    <<: *backend_defaults
    entrypoint:
      - bash
      - -c
    command:
      - |
        exec sleep infinity
    environment:
      FRAPPE_SITE_NAME_HEADER: "${IQ_SITE_NAME_HEADER:-$$host}"
    depends_on:
      init:
        condition: service_completed_successfully
