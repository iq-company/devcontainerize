# This compose file extends the base compose.yml for the development environment.
# It mounts local source code and defines the main application service for debugging.
#
# Note: This file is placed in .devcontainer/ for VSCode devcontainer support.
# It reads the shared .env file from ops/compose/.

x-backend-defaults: &backend_defaults
  image: "${IQ_IMAGE}:${IQ_IMAGE_TAG}"
  platform: linux/amd64
  profiles: ["ddl"]  # Activate DDL profile for dev
  environment:
    # DDL profile: use super-user credentials (empty = use defaults from .env)
    DB_USER: ""
    DB_PASSWORD: ""
  volumes:
    - ../ops/scripts/runtime:/home/{{ image_user }}/bench/bin-dev
    - sites:/home/{{ image_user }}/bench/sites
    - apps:/home/{{ image_user }}/bench/apps
    - type: bind
      source: "${VSCODE_SETTINGS_PATH}"
      target: "/home/{{ image_user }}/.vscode-host"
  env_file:
    - ../ops/compose/.env

services:
  init:
    <<: *backend_defaults
    command: bash -c "DEV_CONTAINER=1 /home/{{ image_user }}/bench/bin-dev/init_site.sh"
    depends_on:
      db:
        condition: service_started
      redis-cache:
        condition: service_started
      redis-queue:
        condition: service_started

  app:
    <<: *backend_defaults
    entrypoint:
      - bash
      - -c
    command:
      - |
        bench start &
        exec sleep infinity
    environment:
      FRAPPE_SITE_NAME_HEADER: ${IQ_SITE_NAME_HEADER:-$$host}
    ports:
      - "${NGINX_PORT}:8000"
      - "8020:8020"
    depends_on:
      init:
        condition: service_completed_successfully
