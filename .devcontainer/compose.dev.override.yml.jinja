# This compose file extends the base compose.yml for the development environment.
# It mounts local source code and defines the main application service for debugging.
#
# Note: This file is placed in .devcontainer/ for VSCode devcontainer support.
# It reads .env (shared defaults) and .env.dev (stage-specific) from ops/env/.

x-backend-defaults: &backend_defaults
  image: "${IQ_IMAGE}:${IQ_IMAGE_TAG}"
  platform: linux/amd64
  # Note: Add "profiles: [...]" here if this service should only start
  # when specific COMPOSE_PROFILES are set in .env
  volumes:
    - sites:/home/{{ image_user }}/bench/sites
    - apps:/home/{{ image_user }}/bench/apps
    - type: bind
      source: "${VSCODE_SETTINGS_PATH}"
      target: "/home/{{ image_user }}/.vscode-host"
  env_file:
    # Paths are relative to compose project directory (ops/compose/, set by first -f file)
    - ../env/.env
    - ../env/.env.dev

services:
  init:
    <<: *backend_defaults
    command: bash -c "DEV_CONTAINER=1 init_site.sh"
    depends_on:
      db:
        condition: service_started
      redis-cache:
        condition: service_started
      redis-queue:
        condition: service_started

  app:
    <<: *backend_defaults
    entrypoint:
      - bash
      - -c
    command:
      - |
        exec sleep infinity
    environment:
      FRAPPE_SITE_NAME_HEADER: "${IQ_SITE_NAME_HEADER:-$$host}"
    depends_on:
      init:
        condition: service_completed_successfully
