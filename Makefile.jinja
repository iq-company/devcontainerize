{%- if feature_image_creation -%}
# Makefile - Utility targets for development and operations
# Docker image builds are handled by baker-cli (see build-settings.yml)
#
# Available targets:
#   make test              - Run tests
#   make add-version       - Bump version number
#   make run-release       - Start release environment
#   make stop-release      - Stop release environment
#   make clean-release     - Clean up release environment

SHELL := /bin/bash

IQ_BRAND_NAME ?= {{ project_name }}
IQ_SITE_NAME ?= {{ site_name }}

.PHONY: test add-version run-release stop-release clean-release

########################################################################
# Test Target
########################################################################
# Usage:
#   make test                   - Run all tests with default settings
#   make test APP=iq_core       - Run tests for a specific app
#   make test MODULE=app.module - Run tests for a specific module
#   make test DOCTYPE=MyType    - Run tests for a specific doctype
#   make test TEST=test_func    - Run a specific test function
#   make test SECTION=Auth      - Run tests for a specific section
#   make test CONTINUE=1        - Continue running tests even after failures
#
# Environment variables:
#   DBMS:     Database system to use (postgres, mariadb, or sqlite)
#   APP:      Filter tests by app
#   SECTION:  Only run a specific SECTION
#   CONTINUE: Set to 1 to continue on errors (default is to stop on first error)
#
#   IQ_SITE_NAME: needs to start with "test_" (default: test_{{ site_name }})
#   DB_HOST:  Database host (default: localhost)
#   DB_PORT:  Database port (default: 5432 for postgres, 3306 for mariadb)
#   DB_SUPER_USER: Needs also to start with "test_" (default: test_iq_su)
#   DB_SUPER_USER_PW: Super user password
#   DB_SCHEMA: Schema name (default: iq_schema, postgres only)
test:
	$(eval override IQ_SITE_NAME := $(if $(filter test_%,$(IQ_SITE_NAME)),$(IQ_SITE_NAME),test_{{ image_prefix }}_site))
	$(eval override DBMS := $(if $(DBMS),$(DBMS),{{ default_dbms }}))
	$(eval override DB_SUPER_USER := $(if $(filter test_%,$(DB_SUPER_USER)),$(DB_SUPER_USER),test_{{ image_prefix }}_su))

	@echo "Starting tests with database: $(DBMS), using site name: $(IQ_SITE_NAME)"
	@cd ../../; \
	if [ ! -d "sites/$(IQ_SITE_NAME)" ]; then \
		echo "Creating test site $(IQ_SITE_NAME) with DBMS=$(DBMS)..."; \
		IQ_ADMIN_PW=admin \
		IQ_SITE_NAME=$(IQ_SITE_NAME) \
		DBMS=$(DBMS) \
		bash apps/{{ app_name }}/.devcontainer/bin/init_site.sh; \
	fi; \
	echo "Running tests with database: $(DBMS)..."; \
	TEST_CMD="bench --site $(IQ_SITE_NAME) run-iq-tests"; \
	if [ -n "$(APP)" ]; then \
		TEST_CMD="$$TEST_CMD --app $(APP)"; \
	fi; \
	if [ -n "$(MODULE)" ]; then \
		TEST_CMD="$$TEST_CMD --module $(MODULE)"; \
	fi; \
	if [ -n "$(DOCTYPE)" ]; then \
		TEST_CMD="$$TEST_CMD --doctype $(DOCTYPE)"; \
	fi; \
	if [ -n "$(TEST)" ]; then \
		TEST_CMD="$$TEST_CMD --test $(TEST)"; \
	fi; \
	if [ -n "$(SECTION)" ]; then \
		TEST_CMD="$$TEST_CMD --section $(SECTION)"; \
	fi; \
	if [ -n "$(CONTINUE)" ] && [ "$(CONTINUE)" = "1" ]; then \
		TEST_CMD="$$TEST_CMD --continue-on-error"; \
	fi; \
	echo "Executing: $$TEST_CMD"; \
	eval $$TEST_CMD

########################################################################
# Version bumping
########################################################################
add-version:
	@current_version=`cat delivery/container-version`; \
	IFS=. read major minor patch <<< "$$current_version"; \
	if [ -z "$(VERSION_COMPONENT)" ]; then \
		echo "Current version: $$current_version"; \
		echo -e "Select component to increment\n\t[m]ajor\n\t[f]eature\n\t[b]ugfix: "; \
		read -p "Choose: m, f, b (default: feature) " component; \
		case $$component in \
			m) component_type="major" ;; \
			f) component_type="feature" ;; \
			b) component_type="bugfix" ;; \
			*) echo "Invalid selection. Using feature as default."; component_type="feature" ;; \
		esac; \
	else \
		component_type="$(VERSION_COMPONENT)"; \
	fi; \
	if [ "$$component_type" = "major" ]; then \
	  new_major=$$((major + 1)); \
	  new_version="$$new_major.0.0"; \
	  echo "Incrementing major version: $$current_version -> $$new_version"; \
	elif [ "$$component_type" = "bugfix" ]; then \
	  new_patch=$$((patch + 1)); \
	  new_version="$$major.$$minor.$$new_patch"; \
	  echo "Incrementing bugfix version: $$current_version -> $$new_version"; \
	elif [ "$$component_type" = "feature" ]; then \
	  new_minor=$$((minor + 1)); \
	  new_version="$$major.$$new_minor.0"; \
	  echo "Incrementing feature version: $$current_version -> $$new_version"; \
	else \
	  echo "Invalid component type: $$component_type. Using feature as default."; \
	  new_minor=$$((minor + 1)); \
	  new_version="$$major.$$new_minor.0"; \
	  echo "Incrementing feature version: $$current_version -> $$new_version"; \
	fi; \
	echo $$new_version > delivery/container-version; \
	sed -i 's/__version__ = "[0-9]*\.[0-9]*\.[0-9]*"/__version__ = "'$$new_version'"/' {{ app_name }}/__init__.py; \
	echo "Updated version in delivery/container-version and {{ app_name }}/__init__.py to $$new_version"; \
	if [ "$(COMMIT)" = "1" ]; then \
		git add delivery/container-version {{ app_name }}/__init__.py; \
		git commit -m "upd: Bump version to $$new_version"; \
		echo "Committed version bump"; \
	fi

########################################################################
# Docker Compose Targets for Release Environment
########################################################################
run-release:
	@echo "Starting release environment..."
	@chmod +x ./ops/scripts/run_release_helper.sh
	@./ops/scripts/run_release_helper.sh $(ENV_FILE)

stop-release:
	@echo "Stopping release environment..."
	@chmod +x ./ops/scripts/stop_release_helper.sh
	@./ops/scripts/stop_release_helper.sh

clean-release:
	@echo "Cleaning release environment..."
	@chmod +x ./ops/scripts/clean_release_helper.sh
	@./ops/scripts/clean_release_helper.sh
{%- endif %}
