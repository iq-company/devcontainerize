# baker-cli build configuration for {{ project_name }}

# Registry/Owner with ENV fallbacks
registry: ${env("REGISTRY","")}
owner: ${env("OWNER", env("GITHUB_REPOSITORY_OWNER",""))}

platforms: ["linux/amd64"]
push: false
check: auto  # auto|local|remote

# Hash settings
hash:
  tag_length: 8

# Build args that flow into all targets
args:
  dep_arg_prefix: "IMAGE_BAKER_"

# Global build args available to all targets
build_args:
  IQ_BRAND_NAME: "{{ project_name }}"
  IQ_SITE_NAME: "{{ site_name }}"

# --- Dockerfile Generation (baker gen-docker) ---
# Path to recipes directory (all .yml files are merged alphabetically)
# Files: 00-base.yml, 10-builder.yml, 20-dev.yml, 30-release.yml, 99-custom.yml
recipes_dir: ops/build/docker-templates/recipes

# Default values for Dockerfile templates (can be overridden via --set)
# Note: Project-specific values (app_name, image_user, etc.) are automatically
#       loaded from .copier-answers.yml
dockerfile_defaults:
  # Version defaults for Debian variant
  python_version: "3.12"
  debian_base: "bookworm"
  node_version: "20"
  pg_version: "16.4"
  nginx_version: "1.27.4"
  # Uncomment for Alpine variant:
  # alpine_version: "3.20"

# Target definitions
# Available tag functions:
#  - env("VAR","default")         -> Environment variable
#  - readFile("path")             -> File content (stripped)
#  - checksum("path1","path2")    -> sha256 of file contents
#  - currentChecksum()            -> Hash based on hash_mode (self or self+deps)
#  - currentChecksum8()           -> Short (8 char) version
#  - depChecksum("targetName")    -> Hash of another target
#  - depChecksum8("targetName")   -> Short version
#  - gitShortSha()                -> `git rev-parse --short HEAD`
#  - concat(a,b,...)              -> String concatenation

targets:
  # Convention over Configuration:
  #   Template:   docker-templates/{target}/Dockerfile.j2
  #   Output:     docker/Dockerfile.{target}
  # Only specify 'dockerfile' or 'dockerfile_template' to override convention.

  base:
    context: .
    deps: []
    hash_mode: self
    hash_files:
      - ops/build/docker/Dockerfile.base
      - ops/build/resources/nginx/nginx-template.conf
      - ops/build/resources/nginx/nginx-entrypoint.sh
      - ops/build/resources/nginx/nginx.conf
      - ops/build/resources/gunicorn/gunicorn.conf.py
    image: {{ image_prefix }}-base
    latest: true

  builder:
    context: .
    deps: [base]
    hash_mode: self+deps
    hash_files:
      - ops/build/docker/Dockerfile.builder
    image: {{ image_prefix }}-builder
    latest: true
    build_args:
      BASE_IMAGE_SOURCE: {{ image_prefix }}-base:${depChecksum8("base")}

  dev:
    context: .
    deps: [base, builder]
    hash_mode: self+deps
    hash_files:
      - ops/build/docker/Dockerfile.dev
      - ops/build/resources/setup_bench_apps.py
      - ops/build/resources/docker-patches.sh
      - ops/build/resources/frappe-patches.sh
      - ops/build/resources/app-patches.sh
    image: {{ image_prefix }}-dev
    # Note: Only VERSION determines rebuild check (first tag is used for existence check).
    # Changes to deps (base, builder) don't trigger rebuild - use --force or bump VERSION.
    tags:
      - ${readFile("ops/build/VERSION")}
      - latest
    build_args:
      BUILDER_IMAGE_SOURCE: {{ image_prefix }}-builder:${depChecksum8("builder")}
      BASE_IMAGE_SOURCE: {{ image_prefix }}-base:${depChecksum8("base")}

  release:
    context: .
    deps: [base, dev]
    hash_mode: self+deps
    hash_files:
      - ops/build/docker/Dockerfile.release
      - ops/build/resources/release-cleaner.sh
      - ops/build/resources/release-final.sh
      - ops/build/resources/call_root_iq_release_dist.py
    image: {{ image_prefix }}-release
    # Note: Only VERSION determines rebuild check (first tag is used for existence check).
    # Changes to deps (base, dev) don't trigger rebuild - use --force or bump VERSION.
    tags:
      - ${readFile("ops/build/VERSION")}
      - latest
    build_args:
      BASE_IMAGE_SOURCE: {{ image_prefix }}-base:${depChecksum8("base")}
      DEV_IMAGE_SOURCE: {{ image_prefix }}-dev:${readFile("ops/build/VERSION")}

# Bundles for convenient multi-target builds
bundles:
  all:
    targets:
      - base
      - builder
      - dev
      - release

  ci:
    targets:
      - dev
      - release
