# baker-cli build configuration for {{ project_name }}

# Registry/Owner with ENV fallbacks
registry: ${env("REGISTRY","")}
owner: ${env("OWNER", env("GITHUB_REPOSITORY_OWNER",""))}

platforms: ["linux/amd64"]
push: false
check: auto  # auto|local|remote

# Hash settings
hash:
  tag_length: 8

# Build args that flow into all targets
args:
  dep_arg_prefix: "IMAGE_BAKER_"

# Global build args available to all targets
build_args:
  IQ_BRAND_NAME: "{{ project_name }}"
  IQ_SITE_NAME: "{{ site_name }}"

# Target definitions
# Available tag functions:
#  - env("VAR","default")         -> Environment variable
#  - readFile("path")             -> File content (stripped)
#  - checksum("path1","path2")    -> sha256 of file contents
#  - currentChecksum()            -> Hash based on hash_mode (self or self+deps)
#  - currentChecksum8()           -> Short (8 char) version
#  - depChecksum("targetName")    -> Hash of another target
#  - depChecksum8("targetName")   -> Short version
#  - gitShortSha()                -> `git rev-parse --short HEAD`
#  - concat(a,b,...)              -> String concatenation

targets:
  base:
    dockerfile: ops/build/docker/Dockerfile.base
    context: .
    deps: []
    hash_mode: self
    hash_files:
      - ops/build/docker/Dockerfile.base
      - ops/build/resources/nginx/nginx-template.conf
      - ops/build/resources/nginx/nginx-entrypoint.sh
      - ops/build/resources/nginx/nginx.conf
      - ops/build/resources/gunicorn/gunicorn.conf.py
    image: {{ image_prefix }}-base
    latest: true

  builder:
    dockerfile: ops/build/docker/Dockerfile.builder
    context: .
    deps: [base]
    hash_mode: self+deps
    hash_files:
      - ops/build/docker/Dockerfile.builder
    image: {{ image_prefix }}-builder
    latest: true
    build_args:
      BASE_IMAGE_SOURCE: "${depChecksum8('base')}"

  dev:
    dockerfile: ops/build/docker/Dockerfile.dev
    context: .
    deps: [base, builder]
    hash_mode: self+deps
    hash_files:
      - ops/build/docker/Dockerfile.dev
      - ops/build/resources/setup_bench_apps.py
      - ops/build/resources/docker-patches.sh
      - ops/build/resources/frappe-patches.sh
      - ops/build/resources/app-patches.sh
    image: {{ image_prefix }}-dev
    tags:
      - ${readFile("ops/build/VERSION")}
      - latest
    build_args:
      BUILDER_IMAGE_SOURCE: {{ image_prefix }}-builder:${depChecksum8("builder")}
      BASE_IMAGE_SOURCE: {{ image_prefix }}-base:${depChecksum8("base")}

  release:
    dockerfile: ops/build/docker/Dockerfile.release
    context: .
    deps: [base, dev]
    hash_mode: self+deps
    hash_files:
      - ops/build/docker/Dockerfile.release
      - ops/build/resources/container-reduce.sh
      - ops/build/resources/call_root_iq_release_dist.py
    image: {{ image_prefix }}-release
    tags:
      - ${readFile("ops/build/VERSION")}
      - latest
    build_args:
      BASE_IMAGE_SOURCE: {{ image_prefix }}-base:${depChecksum8("base")}
      DEV_IMAGE_SOURCE: {{ image_prefix }}-dev:${readFile("ops/build/VERSION")}

  # Alpine-based worker image (experimental)
  # Smaller image size but limited functionality:
  # - No wkhtmltopdf (no PDF generation)
  # - No nginx (use external reverse proxy)
  # Suitable for: background workers, scheduler, CLI operations
  release-alpine:
    dockerfile: ops/build/docker/Dockerfile.release-alpine
    context: .
    deps: [dev]
    hash_mode: self+deps
    hash_files:
      - ops/build/docker/Dockerfile.release-alpine
      - ops/build/resources/container-reduce.sh
      - ops/build/resources/call_root_iq_release_dist.py
    image: {{ image_prefix }}-release-alpine
    tags:
      - ${readFile("ops/build/VERSION")}
      - latest
    build_args:
      DEV_IMAGE_SOURCE: {{ image_prefix }}-dev:${readFile("ops/build/VERSION")}

# Bundles for convenient multi-target builds
bundles:
  all:
    targets:
      - base
      - builder
      - dev
      - release

  ci:
    targets:
      - dev
      - release
