# Alpine-based Release Image for Worker-only deployments
# ========================================================
# WARNING: This image is EXPERIMENTAL and has limitations:
# - No wkhtmltopdf (PDF generation not supported)
# - No nginx (use external reverse proxy)
# - Python packages with C extensions may need recompilation
#
# Use cases:
# - Background workers (queue processing)
# - Scheduler service
# - CLI-only operations
#
# NOT suitable for:
# - Web frontend (no nginx)
# - PDF generation (no wkhtmltopdf)
# - Full Frappe stack deployment

ARG DEV_IMAGE_SOURCE

# Stage 1: Extract Python venv and apps from dev image
FROM ${DEV_IMAGE_SOURCE:-{{ image_prefix }}-dev} AS extractor

ARG IMAGE_USER={{ image_user }}

USER root
WORKDIR /home/${IMAGE_USER}/bench

# Run cleanup tasks
RUN PYTHON_PATH=/home/${IMAGE_USER}/bench/apps python apps/{{ app_name }}/ops/build/resources/call_root_iq_release_dist.py

# Stage 2: Alpine-based final image
FROM python:3.12-alpine AS final

ARG IMAGE_USER={{ image_user }}
ARG IMAGE_GROUP={{ image_group }}
ARG UID=1000
ARG GID=1000

# Install minimal runtime dependencies
RUN apk add --no-cache \
    # Required for some Python packages
    libffi \
    # PostgreSQL client library (if using postgres)
{%- if default_dbms == 'postgres' %}
    libpq \
    postgresql-client \
{%- endif %}
{%- if default_dbms == 'mariadb' %}
    mariadb-client \
    mariadb-connector-c \
{%- endif %}
    # Node.js for socketio (minimal)
    nodejs \
    # Basic utilities
    bash \
    curl \
    jq \
    # For wait-for-it functionality
    netcat-openbsd \
    && addgroup -g ${GID} ${IMAGE_GROUP} \
    && adduser -u ${UID} -G ${IMAGE_GROUP} -h /home/${IMAGE_USER} -s /bin/bash -D ${IMAGE_USER}

# Copy bench directory from extractor
COPY --from=extractor --chown=${IMAGE_USER}:${IMAGE_GROUP} /home/${IMAGE_USER}/bench /home/${IMAGE_USER}/bench

# Set environment
ENV PATH="/home/${IMAGE_USER}/bench/env/bin:${PATH}"
ENV FRAPPE_STREAM_LOGGING=1

USER ${IMAGE_USER}
WORKDIR /home/${IMAGE_USER}/bench

# Health check for worker
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD pgrep -f "bench worker" || exit 1

VOLUME ["/home/${IMAGE_USER}/bench/sites"]

# Default command: run as worker
CMD ["bench", "worker", "--queue", "default,short,long"]
