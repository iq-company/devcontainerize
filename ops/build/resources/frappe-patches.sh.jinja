#!/usr/bin/bash
#
# Frappe Patches - Applied during image build before bench init
#
# This script runs BEFORE bench init, when Frappe is in /tmp/bench/apps/frappe
# or from /home/{{ image_user }}/ or from within a bench directory.
# The calling cwd decides where the frappe source code relies:
# (They may not address files/directories from absolute docker paths but always relative from within the bench directory)
#
# This script does:
#   - Remove unnecessary Python/Node dependencies from Frappe
#   - Apply patches to Frappe source code
#   - Fix CVEs in dependencies
#
# Called from: setup_bench_apps.py
# Working directory: /home/{{ image_user }}
# Frappe location: /tmp/bench/apps/frappe (or $CWD/apps/frappe if running locally)
# (call it locally with: `bash apps/iq_core/delivery/resources/frappe-patches.sh`)

set -e


CWD="$(pwd)"

if [ "$CWD" = "/home/{{ image_user }}" ]; then
    FRAPPE_TARGET_DIR="/tmp/bench/apps/frappe"
elif [ -d "apps" ] && [ -d "sites" ]; then
    FRAPPE_TARGET_DIR="${CWD}/apps/frappe"
else
    echo "Error: Invalid working directory for frappe-patches.sh"
    exit 1
fi

echo "Patching Frappe at: $FRAPPE_TARGET_DIR"

# Example: Remove unused Frappe dependencies for your setup
#
# unneeded_libs=(
# 	"ldap3"
# 	"terminaltables"
# 	"dropbox"
# 	"google-api-python-client"
# 	"google-auth-oauthlib"
# 	"google-auth"
# 	"posthog"
# 	"sentry-sdk"
# )
#
# for lib in "${unneeded_libs[@]}"; do
#     sed -Ei "/$lib[[:space:]]*[~>=\!]+/d" $FRAPPE_TARGET_DIR/pyproject.toml
# done

# Example: Fix a CVE in package.json
# jq '.resolutions = (.resolutions // {}) + {"vulnerable-pkg": "^2.0.0"}' \
#     "$FRAPPE_TARGET_DIR/package.json" > tmp.$$.json && mv tmp.$$.json "$FRAPPE_TARGET_DIR/package.json"

echo "Frappe patches applied."
