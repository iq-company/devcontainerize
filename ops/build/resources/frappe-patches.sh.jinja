#!/usr/bin/bash
#
# Frappe Patches - Applied during image build before bench init
#
# This script runs BEFORE bench init, when Frappe is in /tmp/bench/apps/frappe
# or from /home/{{ image_user }}/ or from within a bench directory.
# The calling cwd decides where the frappe source code relies:
# (They may not address files/directories from absolute docker paths but always relative from within the bench directory)
#
# This script does:
#   - Remove unnecessary Python/Node dependencies from Frappe
#   - Apply patches to Frappe source code
#   - Fix CVEs in dependencies
#
# Called from: setup_bench_apps.py
# Working directory: /home/{{ image_user }}
# Frappe location: /tmp/bench/apps/frappe (or $CWD/apps/frappe if running locally)
# (call it locally with: `bash apps/{{ app_name }}/ops/build/resources/frappe-patches.sh`)

set -e

# =============================================================================
# Helper Functions
# =============================================================================

# Remove a Python dependency from pyproject.toml
# Usage: remove_py_dep "package-name"
remove_py_dep() {
    local lib="$1"
    sed -Ei "/$lib[[:space:]]*[~>=\!]+/d" "$FRAPPE_TARGET_DIR/pyproject.toml"
}

# Remove import lines matching a pattern from a file
# Usage: remove_import "pattern" "file"
remove_import() {
    local pattern="$1"
    local file="$2"
    sed -i "/$pattern/d" "$file"
}

# Add or update a resolution in package.json (for CVE fixes)
# Usage: add_npm_resolution "package-name" "version"
add_npm_resolution() {
    local package="$1"
    local version="$2"
    jq ".resolutions = (.resolutions // {}) + {\"$package\": \"$version\"}" \
        "$FRAPPE_TARGET_DIR/package.json" > tmp.$$.json && \
        mv tmp.$$.json "$FRAPPE_TARGET_DIR/package.json"
}

# =============================================================================
# Determine Frappe Directory
# =============================================================================

CWD="$(pwd)"

if [ "$CWD" = "/home/{{ image_user }}" ]; then
    FRAPPE_TARGET_DIR="/tmp/bench/apps/frappe"
elif [ -d "apps" ] && [ -d "sites" ]; then
    FRAPPE_TARGET_DIR="${CWD}/apps/frappe"
else
    echo "Error: Invalid working directory for frappe-patches.sh"
    exit 1
fi

echo "Patching Frappe at: $FRAPPE_TARGET_DIR"

# Get the directory where this script resides (for resource files like jquery)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# =============================================================================
# 1. Remove Unused Translations (before bench build compiles them)
# =============================================================================
# Frappe ships ~40 MB of translations (CSV + gettext PO) for 70+ languages.
# Keep only the languages needed for this project to save image size and
# speed up "Compiling translations..." during bench build.
# English is the source language (no en.csv/en.po) — always available.

KEEP_LANGS="{{ keep_languages }}"   # space-separated, configured in copier.yaml

echo "Removing unused translations (keeping: $KEEP_LANGS) ..."

# --- CSV translations (frappe/translations/*.csv) ---
TRANSLATIONS_DIR="$FRAPPE_TARGET_DIR/frappe/translations"
if [ -d "$TRANSLATIONS_DIR" ]; then
    for csv_file in "$TRANSLATIONS_DIR"/*.csv; do
        [ -f "$csv_file" ] || continue
        lang_code="$(basename "$csv_file" .csv)"
        keep=false
        for k in $KEEP_LANGS; do
            [ "$lang_code" = "$k" ] && keep=true && break
        done
        if [ "$keep" = false ]; then
            rm -f "$csv_file"
        fi
    done
    remaining=$(ls "$TRANSLATIONS_DIR"/*.csv 2>/dev/null | wc -l)
    echo "  CSV translations: kept $remaining files"
fi

# --- Gettext PO/POT (frappe/locale/*.po) ---
LOCALE_DIR="$FRAPPE_TARGET_DIR/frappe/locale"
if [ -d "$LOCALE_DIR" ]; then
    for po_file in "$LOCALE_DIR"/*.po; do
        [ -f "$po_file" ] || continue
        lang_code="$(basename "$po_file" .po)"
        keep=false
        for k in $KEEP_LANGS; do
            [ "$lang_code" = "$k" ] && keep=true && break
        done
        if [ "$keep" = false ]; then
            rm -f "$po_file"
        fi
    done
    # Keep main.pot (template) — it's needed by compile_translations
    remaining=$(ls "$LOCALE_DIR"/*.po 2>/dev/null | wc -l)
    echo "  PO translations: kept $remaining files (+ main.pot)"
fi

# =============================================================================
# 2. Remove Unused Python Dependencies
# =============================================================================
# Uncomment and customize the libraries you want to remove:
#
# echo "Removing unused Python dependencies..."
#
# unneeded_libs=(
#     "PyQRCode"          # QR code generation
#     "ldap3"             # LDAP authentication
#     "terminaltables"    # Terminal table formatting
#     "dropbox"           # Dropbox integration
#     "google-api-python-client"  # Google APIs
#     "google-auth-oauthlib"      # Google OAuth
#     "google-auth"               # Google authentication
#     "posthog"           # Telemetry/analytics
#     "maxminddb-geolite2"  # GeoIP lookup
#     "sentry-sdk"        # Error tracking
#     "vobject"           # vCard/iCalendar support
#     "weasyprint"        # PDF generation (alternative to wkhtmltopdf)
# )
#
# for lib in "${unneeded_libs[@]}"; do
#     remove_py_dep "$lib"
# done

# =============================================================================
# 3. Patch Removed Dependencies (prevent import errors)
# =============================================================================
# When removing dependencies, you may need to patch import statements
# to prevent errors when Frappe tries to load the modules.
#
# Example - Remove LDAP imports (multiline):
# sed -i '/^import ldap3/d; /^from ldap3[^(]*$/d; /^from ldap3[^(]*(/,/^[[:space:]]*)/d' \
#     "$FRAPPE_TARGET_DIR/frappe/integrations/doctype/ldap_settings/ldap_settings.py"
#
# Example - Remove single import line:
# remove_import "import dropbox" \
#     "$FRAPPE_TARGET_DIR/frappe/integrations/doctype/dropbox_settings/dropbox_settings.py"
#
# Example - Remove Google integrations:
# remove_import "from google" "$FRAPPE_TARGET_DIR/frappe/integrations/google_oauth.py"
#
# Example - Remove Sentry:
# remove_import "from frappe.utils.sentry" "$FRAPPE_TARGET_DIR/frappe/utils/error.py"
# remove_import "capture_exception" "$FRAPPE_TARGET_DIR/frappe/utils/error.py"

# =============================================================================
# 4. JavaScript/Node Patches
# =============================================================================
# Example - Remove a dependency from package.json:
# sed -i '/@vue\/component-compiler/d' "$FRAPPE_TARGET_DIR/package.json"
#
# Example - Remove postinstall script:
# jq 'del(.scripts.postinstall)' "$FRAPPE_TARGET_DIR/package.json" > \
#     "$FRAPPE_TARGET_DIR/package.tmp.json" && \
#     mv "$FRAPPE_TARGET_DIR/package.tmp.json" "$FRAPPE_TARGET_DIR/package.json"
#
#
# Bump esbuild target from es2017 to es2020 to suppress import.meta warnings
# from dependencies like zustand that use import.meta.env in their ESM builds.
# ES2020 is supported by all modern browsers (Chrome 80+, Firefox 74+, Safari 14+).
sed -i 's/target: \[.*\],/target: ["es2020"],/' "$FRAPPE_TARGET_DIR/esbuild/esbuild.js"

# =============================================================================
# 5. CVE Fixes (npm resolutions)
# =============================================================================
# Use add_npm_resolution to pin vulnerable packages to fixed versions:
#
# add_npm_resolution "@adobe/css-tools" "4.3.3"
# add_npm_resolution "postcss" "8.4.47"

echo "Frappe patches applied."
