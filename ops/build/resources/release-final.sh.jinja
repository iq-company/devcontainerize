#!/bin/sh
# =============================================================================
# Release Final Cleanup
# =============================================================================
# This script runs in the FINAL stage of Dockerfile.release, AFTER:
#   1. Files are copied from cleaner stage
#   2. pip install frappe-bench has run
#
# It handles pip-related cleanups that must happen AFTER pip reinstall,
# because the reinstall would restore them.
# =============================================================================

set -e

IMAGE_USER="${IMAGE_USER:-{{ image_user }}}"
BENCH_PATH="/home/${IMAGE_USER}/bench"

# Detect Python version in venv
PYTHON_VENV_VERSION=$(ls "${BENCH_PATH}/env/lib/" | grep -E '^python[0-9]+\.[0-9]+' | head -1)
SITE_PACKAGES="${BENCH_PATH}/env/lib/${PYTHON_VENV_VERSION}/site-packages"

echo "Running release final cleanup..."
echo "  SITE_PACKAGES: ${SITE_PACKAGES}"

# Remove 'import git' from bench modules (git not installed in release image)
echo "  Removing 'import git' from bench modules..."
sed -i 's/import git//' "${SITE_PACKAGES}/bench/utils/app.py" 2>/dev/null || true
sed -i 's/import git//' "${SITE_PACKAGES}/bench/app.py" 2>/dev/null || true

# Remove gitpython entirely (git binary not available in release image)
# gitpython's __init__.py runs git --version on import, causing shell errors
echo "  Removing gitpython from venv..."
"${BENCH_PATH}/env/bin/python" -m pip uninstall -y GitPython gitdb smmap 2>/dev/null || true

# Remove pip from venv (CVE reduction, not needed at runtime)
echo "  Removing pip from venv..."
"${BENCH_PATH}/env/bin/python" -m pip uninstall -y pip 2>/dev/null || true

# Remove test directories and unnecessary packages
echo "  Removing test directories and unused packages..."
rm -rf "${SITE_PACKAGES}/h11/tests/" 2>/dev/null || true
rm -rf "${SITE_PACKAGES}/parso"* 2>/dev/null || true

echo "Release final cleanup complete."
