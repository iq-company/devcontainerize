{# =============================================================================
   Dockerfile Template for {{ project_name }} - base target
   ============================================================================= #}
{% raw %}# =============================================================================
# {{ defaults.project_name }} - Base Image
# =============================================================================
# Generated by: bench ops dockerfile create --variant {{ variant }}
# DO NOT EDIT - regenerate with: bench ops dockerfile update -t base
# =============================================================================

ARG PYTHON_VERSION={{ defaults.python_version }}
{% if base_variant == "alpine" %}
FROM python:${PYTHON_VERSION}-alpine{{ defaults.alpine_version }}
{% else %}
ARG DEBIAN_BASE={{ defaults.debian_base }}
FROM python:${PYTHON_VERSION}-slim-${DEBIAN_BASE}
{% endif %}

ARG IMAGE_USER={{ defaults.image_user }}
ARG IMAGE_GROUP={{ defaults.image_group }}

ARG WKHTMLTOPDF_VERSION=0.12.6.1-3
ARG WKHTMLTOPDF_DISTRO={{ defaults.debian_base }}
ARG NODE_VERSION={{ defaults.node_version }}
ENV NVM_DIR=/home/${IMAGE_USER}/.nvm

# Runtime scripts path (populated in dev/release), NVM, and venv
ENV PATH="/home/${IMAGE_USER}/bench/apps/{{ defaults.app_name }}/ops/scripts/runtime:${NVM_DIR}/versions/node/v${NODE_VERSION}/bin:/home/${IMAGE_USER}/bench/env/bin:${PATH}"

ARG IQ_SITE_NAME="{{ defaults.site_name | default(defaults.app_name + '.local') }}"
ENV IQ_SITE_NAME=${IQ_SITE_NAME}

ARG IQ_BRAND_NAME="{{ defaults.project_name }}"
ENV IQ_BRAND_NAME=${IQ_BRAND_NAME}

ARG IQ_APP_NAME='{{ defaults.app_name }}'
ENV FRAPPE_STREAM_LOGGING=1

ARG UID=1000
ARG GID=1000

ENV LD_LIBRARY_PATH="/home/${IMAGE_USER}/bench/sites/extensions/lib"

# --- Create user and install base packages ---
{% if base_variant == "alpine" %}
RUN set -ex; \
    addgroup -g ${GID} ${IMAGE_GROUP}; \
    adduser -u ${UID} -G ${IMAGE_GROUP} -D -s /bin/sh ${IMAGE_USER}; \
    {{ recipe_raw("install_base_packages") }}; \
    {{ recipe_raw("install_nvm") }}; \
    {{ recipe_raw("cleanup_base") }}
{% else %}
RUN set -ex; \
    groupadd -g ${GID} ${IMAGE_GROUP}; \
    useradd -u ${UID} -g ${IMAGE_GROUP} -m -s /bin/bash ${IMAGE_USER}; \
    {{ recipe_raw("install_base_packages") }}; \
    {{ recipe_raw("install_nvm") }}; \
    {{ recipe_raw("install_wkhtmltopdf") }}; \
    {{ recipe_raw("cleanup_base") }}
{% endif %}

COPY --chown=${IMAGE_USER}:${IMAGE_GROUP} --chmod=0644 ops/build/resources/nginx/nginx-template.conf /templates/nginx/{{ defaults.app_name }}.conf.template
COPY --chown=${IMAGE_USER}:${IMAGE_GROUP} --chmod=0755 ops/build/resources/nginx/nginx-entrypoint.sh /usr/local/bin/nginx-entrypoint.sh
COPY --chown=${IMAGE_USER}:${IMAGE_GROUP} ops/build/resources/nginx/nginx.conf /templates/nginx/nginx.conf
COPY --chown=${IMAGE_USER}:${IMAGE_GROUP} ops/build/resources/gunicorn/gunicorn.conf.py /srv/gunicorn.conf.py
{% if base_variant == "alpine" %}
# Alpine: wait-for-it not available as package, use local copy
# Source: https://github.com/vishnubob/wait-for-it (MIT License)
COPY --chmod=0755 ops/build/resources/wait-for-it.sh /usr/local/bin/wait-for-it
{% endif %}

USER ${IMAGE_USER}
WORKDIR /home/${IMAGE_USER}

CMD [ \
    "/home/${IMAGE_USER}/bench/env/bin/gunicorn", \
    "-c", "/srv/gunicorn.conf.py", \
    "--chdir=/home/${IMAGE_USER}/bench/sites", \
    "frappe.app:application" \
    ]
{% endraw %}