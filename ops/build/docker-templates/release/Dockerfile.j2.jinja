{# =============================================================================
   Dockerfile Template for {{ project_name }} - release target
   ============================================================================= #}
{% raw %}# =============================================================================
# {{ defaults.project_name }} - Release Image
# =============================================================================
# Generated by: bench ops dockerfile create --variant {{ variant }}
# DO NOT EDIT - regenerate with: bench ops dockerfile update -t release
# =============================================================================

ARG BASE_IMAGE_SOURCE
ARG DEV_IMAGE_SOURCE

# Stage 1: Cleaning stage
FROM ${DEV_IMAGE_SOURCE:-{{ defaults.image_prefix }}-dev} AS cleaner

ARG IMAGE_USER={{ defaults.image_user }}

USER root

WORKDIR /home/${IMAGE_USER}/bench

# Run app-specific cleanup tasks defined in hooks
RUN PYTHON_PATH=/home/${IMAGE_USER}/bench/apps python apps/{{ defaults.app_name }}/ops/build/resources/call_root_iq_release_dist.py

# Stage 2: Final stage with only cleaned files
FROM ${BASE_IMAGE_SOURCE:-{{ defaults.image_prefix }}-base} AS final

ARG IMAGE_USER={{ defaults.image_user }}
ARG IMAGE_GROUP={{ defaults.image_group }}

USER root

# Ensure nginx directories and templates are accessible
RUN chown -R ${IMAGE_USER}:${IMAGE_GROUP} /etc/nginx /var/log/nginx /run/nginx /templates 2>/dev/null || true; \
    chmod -R g+rw /etc/nginx /var/log/nginx /run/nginx 2>/dev/null || true; \
    chmod 644 /templates/nginx/*.template 2>/dev/null || true

RUN find /home/${IMAGE_USER}/bench/sites_assets/ -type d -print0 | xargs -0 -r chmod 775 ; \
    find /home/${IMAGE_USER}/bench/sites_assets/ -type f -print0 | xargs -0 -r chmod 644

# --- Remove unnecessary files to reduce image size ---
{{ recipe("cleanup_release") }}

{% if base_variant == "debian" %}
# Copy psql from cleaner (debian compiled version)
COPY --from=cleaner /usr/local/bin/psql /usr/local/bin/psql
COPY --from=cleaner /lib/x86_64-linux-gnu/libpq.so* /lib/x86_64-linux-gnu/
{% endif %}

# Copy only the cleaned files from the cleaner stage
COPY --from=cleaner --chown=${IMAGE_USER}:${IMAGE_GROUP} /home/${IMAGE_USER}/bench /home/${IMAGE_USER}/bench
{% if base_variant == "debian" %}
# Debian: Copy compiled nginx and pcre2
COPY --from=cleaner --chown=${IMAGE_USER}:${IMAGE_GROUP} /opt/nginx/ /opt/nginx/
COPY --from=cleaner --chown=${IMAGE_USER}:${IMAGE_GROUP} /opt/pcre2/* /opt/pcre2/
{% else %}
# Alpine: nginx is installed via apk, just ensure directories exist
RUN mkdir -p /var/lib/nginx && chown -R ${IMAGE_USER}:${IMAGE_GROUP} /var/lib/nginx
{% endif %}

ENV PATH="/home/${IMAGE_USER}/bench/env/bin:${PATH}"

USER ${IMAGE_USER}

RUN chmod -R g+rw /home/${IMAGE_USER}/bench/config

WORKDIR /home/${IMAGE_USER}/bench

VOLUME [ \
    "/home/${IMAGE_USER}/bench/sites" \
    ]
{% endraw %}