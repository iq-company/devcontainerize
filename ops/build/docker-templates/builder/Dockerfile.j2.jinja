{# =============================================================================
   Dockerfile Template for {{ project_name }} - builder target
   ============================================================================= #}
{% raw %}
# =============================================================================
# {{ defaults.project_name }} - Builder Image
# =============================================================================
# Generated by: bench ops dockerfile create --variant {{ variant }}
# DO NOT EDIT - regenerate with: bench ops dockerfile update -t builder
# =============================================================================

ARG BASE_IMAGE_SOURCE
FROM ${BASE_IMAGE_SOURCE:-{{ defaults.image_prefix }}-base}

ARG IMAGE_USER={{ defaults.image_user }}
ARG IMAGE_GROUP={{ defaults.image_group }}

USER root

# --- Install build dependencies ---
{% if base_variant == "alpine" %}
RUN set -ex; \
    {{ recipe_raw("install_builder_packages") }}; \
    pip3 install frappe-bench
{% else %}
RUN set -ex; \
    {{ recipe_raw("install_builder_packages") }}; \
    apt-get autoremove -y; \
    apt-get clean; \
    pip3 install frappe-bench
{% endif %}

# Pre-create directories for user compilation
RUN mkdir -p /opt/nginx /opt/pcre2 && chown -R ${IMAGE_USER}:${IMAGE_GROUP} /opt/nginx /opt/pcre2

USER ${IMAGE_USER}

# --- Compile DBMS client, pcre2, nginx ---
{% if base_variant == "debian" %}
RUN set -x; \
    {{ recipe_raw("compile_dbms") }}; \
    {{ recipe_raw("compile_pcre2") }}; \
    {{ recipe_raw("compile_nginx") }}

RUN mkdir -p /opt/nginx/conf/conf.d/ \
        /opt/nginx/conf/sites-enabled \
        /opt/nginx/conf/sites-available \
        /opt/nginx/conf/modules-enabled \
        /opt/nginx/conf/modules-available; \
    cp /templates/nginx/nginx.conf /opt/nginx/conf/nginx.conf; \
    touch /opt/nginx/logs/access.log \
          /opt/nginx/logs/error.log; \
    ln -sf /dev/stdout /opt/nginx/logs/access.log && ln -sf /dev/stderr /opt/nginx/logs/error.log
{% else %}
# Alpine: use package manager for nginx instead of compilation
USER root
RUN apk add --no-cache nginx nginx-mod-http-headers-more && \
    mkdir -p /opt/nginx/sbin /opt/nginx/logs /etc/nginx/conf.d /etc/nginx/sites-enabled && \
    ln -sf /usr/sbin/nginx /opt/nginx/sbin/nginx && \
    ln -sf /etc/nginx /opt/nginx/conf && \
    touch /var/log/nginx/access.log /var/log/nginx/error.log && \
    ln -sf /dev/stdout /var/log/nginx/access.log && \
    ln -sf /dev/stderr /var/log/nginx/error.log && \
    chown -R ${IMAGE_USER}:${IMAGE_GROUP} /opt/nginx /var/log/nginx /var/lib/nginx
USER ${IMAGE_USER}
{% endif %}
{% endraw %}
