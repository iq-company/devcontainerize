{# =============================================================================
   Dockerfile Template for {{ project_name }} - dev target
   Generated from: devcontainerize_template/ops/build/docker-templates/dev/Dockerfile.j2.jinja

   This file is processed by:
   1. Copier (interpolates {{ "{{" }} app_name {{ "}}" }}, {{ "{{" }} image_user {{ "}}" }}, etc.)
   2. bench ops dockerfile (interpolates {{ "{{" }} recipe(...) {{ "}}" }}, {{ "{{" }} defaults.* {{ "}}" }})

   Usage: bench ops dockerfile create --variant debian -t dev
   ============================================================================= #}
{% raw %}# =============================================================================
# {{ defaults.project_name }} - Development Image
# =============================================================================
# Generated by: bench ops dockerfile create --variant {{ variant }}
# Template: ops/build/docker-templates/dev/Dockerfile.j2
# DO NOT EDIT - regenerate with: bench ops dockerfile update -t dev
# =============================================================================

ARG BUILDER_IMAGE_SOURCE
ARG BASE_IMAGE_SOURCE

FROM ${BUILDER_IMAGE_SOURCE:-{{ defaults.image_prefix }}-builder} AS builder
FROM ${BASE_IMAGE_SOURCE:-{{ defaults.image_prefix }}-base} AS dev-base

ARG IMAGE_USER={{ defaults.image_user }}
ARG IMAGE_GROUP={{ defaults.image_group }}
ENV IMAGE_USER=${IMAGE_USER}

ARG CUSTOM_APPS
ARG GITHUB_USER=x-oauth-basic
ARG GITHUB_TOKEN
ARG PRODUCTION_BUILD=false

ARG FRAPPE_REF={{ defaults.frappe_ref | default(defaults.frappe_branch, true) | default('version-15', true) }}
ARG FRAPPE_PATH=https://github.com/frappe/frappe

# --- Copy compiled binaries from builder (variant-specific) ---
{% if base_variant == "debian" %}
{{ recipe_raw("copy_from_builder_dbms") }}
{{ recipe_raw("copy_from_builder_nginx") }}
{% endif %}

USER root

# --- Install build dependencies (single layer for size optimization) ---
RUN set -ex; \
    {{ recipe_raw("install_frappe_deps") }} && \
    pip install frappe-bench

USER ${IMAGE_USER}

COPY --chown={{ defaults.image_user }}:{{ defaults.image_group }} . /opt/apps/{{ defaults.app_name }}

# --- Setup bench and apps (single layer with cleanup) ---
RUN set -ex; \
    {{ recipe_raw("setup_bench_apps") }}; \
    {{ recipe_raw("cleanup_frappe") }}

##

WORKDIR /home/${IMAGE_USER}/bench
USER root

COPY --chmod=0755 ops/build/resources/docker-patches.sh /home/${IMAGE_USER}/docker-patches.sh

{{ recipe("run_docker_patches") }}

USER ${IMAGE_USER}

{{ recipe("fix_nginx_permissions") }}

{{ recipe("verify_build") }}

# ##############################
# Final stage
# ##############################
FROM dev-base AS final

USER ${IMAGE_USER}
WORKDIR /home/${IMAGE_USER}/bench

# Add help alias
RUN echo 'alias h="bash ~/bench/apps/{{ defaults.app_name }}/ops/scripts/runtime/help.sh"' >> ~/.bashrc
{% endraw %}