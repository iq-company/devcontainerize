{# =============================================================================
   Dockerfile Template for {{ project_name }} - dev target
   Generated from: devcontainerize_template/ops/build/docker-templates/dev/Dockerfile.j2.jinja

   This file is processed by:
   1. Copier (interpolates {{ "{{" }} app_name {{ "}}" }}, {{ "{{" }} image_user {{ "}}" }}, etc.)
   2. bench ops dockerfile (interpolates {{ "{{" }} recipe(...) {{ "}}" }}, {{ "{{" }} defaults.* {{ "}}" }})

   Usage: bench ops dockerfile create --variant debian -t dev
   ============================================================================= #}
{% raw %}# =============================================================================
# {{ defaults.project_name }} - Development Image
# =============================================================================
# Generated by: bench ops dockerfile create --variant {{ variant }}
# Template: ops/build/docker-templates/dev/Dockerfile.j2
# DO NOT EDIT - regenerate with: bench ops dockerfile update -t dev
# =============================================================================

ARG BUILDER_IMAGE_SOURCE
ARG BASE_IMAGE_SOURCE

FROM ${BUILDER_IMAGE_SOURCE:-{{ defaults.image_prefix }}-builder} AS builder
FROM ${BASE_IMAGE_SOURCE:-{{ defaults.image_prefix }}-base} AS dev-base

ARG IMAGE_USER={{ defaults.image_user }}
ARG IMAGE_GROUP={{ defaults.image_group }}
ENV IMAGE_USER=${IMAGE_USER}

ARG CUSTOM_APPS
ARG GITHUB_USER=x-oauth-basic
ARG GITHUB_TOKEN
ARG PRODUCTION_BUILD=false

ARG FRAPPE_REF={{ defaults.frappe_ref | default(defaults.frappe_branch, true) | default('version-15', true) }}
ARG FRAPPE_PATH=https://github.com/frappe/frappe

# Disable uv (Rust-based package manager) — saves ~54 MB and avoids CVEs.
# frappe-bench falls back to standard pip when this is set.
ENV BENCH_DISABLE_UV=1

# --- Copy compiled binaries from builder (variant-specific) ---
{% if base_variant == "debian" %}
{{ recipe_raw("copy_from_builder_dbms") }}
{{ recipe_raw("copy_from_builder_nginx") }}
{% endif %}

USER root

# --- Install OS build dependencies (cached layer, only changes on base image update) ---
RUN set -ex; \
    {{ recipe_raw("install_frappe_deps") }}

COPY --chown={{ defaults.image_user }}:{{ defaults.image_group }} . /opt/apps/{{ defaults.app_name }}
COPY --chmod=0755 ops/build/resources/docker-patches.sh /home/${IMAGE_USER}/docker-patches.sh
COPY --chmod=0755 ops/build/resources/dev-cleaner*.sh /home/${IMAGE_USER}/

# Runtime scripts: copy to /usr/local/bin/ as volume-safe fallback.
# The primary PATH entry points into the apps volume, which is masked when an
# EXISTING named volume is mounted (Docker only populates volumes on first create).
# /usr/local/bin/ is always on PATH and never masked, so init_site.sh etc. are always found.
COPY --chmod=0755 ops/scripts/runtime/ /usr/local/bin/

# --- Setup bench and apps (single layer: install bench CLI → setup → cleanup) ---
# pip install frappe-bench + pip uninstall in same layer → no wasted space
RUN set -ex; \
    pip install --no-cache-dir frappe-bench; \
    # Run bench setup as app user (su resets HOME correctly)
    su -s /bin/bash ${IMAGE_USER} -c "\
        set -ex; \
        {{ recipe_raw("setup_bench_apps") }}; \
        /home/${IMAGE_USER}/bench/env/bin/pip install --no-cache-dir frappe-bench; \
        {{ recipe_raw("cleanup_frappe") }}"; \
    # Docker patches (branding, etc.) - runs as root
    {{ recipe_raw("run_docker_patches") }}; \
    # Clean up system-level Python packages (frappe-bench only needed for bench init)
    # Same layer as install → actually saves ~33MB
    {{ recipe_raw("cleanup_system_python") }}

USER ${IMAGE_USER}

{{ recipe("fix_bench_permissions") }}

{{ recipe("verify_build") }}

# ##############################
# Final stage
# ##############################
FROM dev-base AS final

USER ${IMAGE_USER}
WORKDIR /home/${IMAGE_USER}/bench

# Add help alias
RUN echo 'alias h="bash ~/bench/apps/{{ defaults.app_name }}/ops/scripts/runtime/help.sh"' >> ~/.bashrc
{% endraw %}
