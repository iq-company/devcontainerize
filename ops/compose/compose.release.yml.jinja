# This compose file extends the base compose.yml for the "release" scenario.
# .env contains shared defaults, STAGE_ENV_FILE (set by CLI) contains stage-specific overrides

x-backend-defaults: &backend_defaults
  image: ${IQ_IMAGE:-{{ image_prefix }}-release}:${IQ_IMAGE_TAG:-latest}
  platform: linux/amd64
  volumes:
    - sites:/home/{{ image_user }}/bench/sites
  env_file:
    - ../env/.env
    - ../env/${STAGE_ENV_FILE:-.env.dev}
  depends_on:
    init:
      condition: service_completed_successfully

services:
  backend:
    <<: *backend_defaults
    command: bench serve

  frontend:
    <<: *backend_defaults
    command: nginx-entrypoint.sh
    environment:
      BACKEND: backend:8000
      SOCKETIO: websocket:9000
      FRAPPE_SITE_NAME_HEADER: ${IQ_SITE_NAME:-$host}
    ports:
      - "${NGINX_PORT}:8080"
    depends_on:
      - backend
      - websocket

  websocket:
    <<: *backend_defaults
    command: node /home/{{ image_user }}/bench/apps/frappe/socketio.js

  queue-short:
    <<: *backend_defaults
    command: bench worker --queue short,default

  queue-long:
    <<: *backend_defaults
    command: bench worker --queue long,default,short

  scheduler:
    <<: *backend_defaults
    command: bench schedule
