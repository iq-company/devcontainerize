# Init service for PostgreSQL - creates site if not exists
# Profile: stack - only starts when stack profile is active
# In DevContainer, compose.dev.override.yml overrides this with dev-specific volumes
#
# .env contains shared defaults, STAGE_ENV_FILE (set by CLI) contains stage-specific overrides

services:
  init:
    image: ${IQ_IMAGE:-{{ image_prefix }}-release}:${IQ_IMAGE_TAG:-latest}
    platform: linux/amd64
    profiles:
      - stack
    env_file:
      - ../env/.env
      - ../env/${STAGE_ENV_FILE:-.env.dev}
    volumes:
      - sites:/home/{{ image_user }}/bench/sites
    entrypoint: ["bash", "-c", "init_site.sh"]
    depends_on:
      db:
        condition: service_started
      redis-cache:
        condition: service_started
      redis-queue:
        condition: service_started
