# Production stack services (backend, frontend, workers, scheduler)
# Profile: stack - only starts when stack profile is active
# In DevContainer, the Procfile handles these services instead
#
# .env contains shared defaults, STAGE_ENV_FILE (set by CLI) contains stage-specific overrides
#
# depends_on init works for all stages:
#   - INIT_MODE=migrate: init waits for services, creates/migrates, stack starts
#   - INIT_MODE=wait: init waits for services only, stack starts

x-backend-defaults: &backend_defaults
  image: ${IQ_IMAGE:-{{ image_prefix }}-release}:${IQ_IMAGE_TAG:-latest}
  platform: linux/amd64
  profiles:
    - stack
  volumes:
    - sites:/home/{{ image_user }}/bench/sites
  env_file:
    - ../env/.env
    - ../env/${STAGE_ENV_FILE:-.env.dev}
  depends_on:
    init:
      condition: service_completed_successfully

services:
  backend:
    <<: *backend_defaults
    command: bench serve

  frontend:
    <<: *backend_defaults
    command: nginx-entrypoint.sh
    environment:
      BACKEND: backend:8000
      SOCKETIO: websocket:9000
      IQ_SITE_NAME_HEADER: ${IQ_SITE_NAME:-$$host}
      # SOCKETIO_INTERNAL_ROUTING:
      # Set to 1 if socketio directly connects to backend for auth verification, 0 if
      # socketio can resolve nginx host (not for localhost, *.local or other unreachable dns names)
      SOCKETIO_INTERNAL_ROUTING: ${SOCKETIO_INTERNAL_ROUTING:-1}
    ports:
      - "${NGINX_PORT}:8080"
    depends_on:
      - backend
      - websocket

  websocket:
    <<: *backend_defaults
    command: node /home/{{ image_user }}/bench/apps/frappe/socketio.js

  queue-short:
    <<: *backend_defaults
    command: bench worker --queue short,default

  queue-long:
    <<: *backend_defaults
    command: bench worker --queue long,default,short

  scheduler:
    <<: *backend_defaults
    command: bench schedule
