"""
Bench ops CLI - Operations commands for template updates, builds, and maintenance.

Usage:
    bench ops template update       # Update from template
    bench ops template status       # Show template version
    bench ops version bump          # Bump version number
    bench ops test                  # Run tests
    bench ops release run           # Start release environment
    bench ops release stop          # Stop release environment
    bench ops release clean         # Clean release environment
"""

import os
import re
import subprocess
import sys
from pathlib import Path

import click


def get_app_root() -> Path:
    """Get the app root directory (where ops/ is located)."""
    return Path(__file__).parents[2]


def get_bench_root() -> Path:
    """Get the bench root directory."""
    return Path(__file__).parents[4]


# =============================================================================
# Main CLI Group
# =============================================================================

@click.group()
def ops():
    """Operations CLI for template updates, builds, and maintenance."""
    pass


# =============================================================================
# Template Commands
# =============================================================================

@ops.group()
def template():
    """Template management commands."""
    pass


@template.command("update")
@click.option("--dry", is_flag=True, help="Dry run (preview changes without applying)")
@click.option("--force", is_flag=True, help="Force update (overwrite local changes)")
def template_update(dry: bool, force: bool):
    """Update from devcontainerize template (copier update --trust)."""
    app_root = get_app_root()
    answers_file = app_root / "ops" / "build" / ".copier-answers.yml"

    cmd = ["copier", "update", "--trust"]

    if answers_file.exists():
        cmd.extend(["--answers-file", str(answers_file)])

    if dry:
        cmd.append("--pretend")
        click.echo("üîç Dry run - showing what would change:")

    if force:
        cmd.append("--force")

    click.echo(f"Running: {' '.join(cmd)}")
    result = subprocess.run(cmd, cwd=app_root)
    sys.exit(result.returncode)


@template.command("status")
def template_status():
    """Show current template version and source."""
    app_root = get_app_root()
    answers_file = app_root / "ops" / "build" / ".copier-answers.yml"

    if not answers_file.exists():
        # Try legacy location
        answers_file = app_root / ".copier-answers.yml"

    if answers_file.exists():
        click.echo(f"üìÑ Answers file: {answers_file}")
        click.echo("‚îÄ" * 40)
        click.echo(answers_file.read_text())
    else:
        click.echo("‚ùå No .copier-answers.yml found")
        click.echo("   This project may not have been created with copier.")


# =============================================================================
# Version Commands
# =============================================================================

@ops.group()
def version():
    """Version management commands."""
    pass


@version.command("show")
def version_show():
    """Show current version."""
    app_root = get_app_root()
    version_file = app_root / "ops" / "build" / "VERSION"

    if version_file.exists():
        ver = version_file.read_text().strip()
        click.echo(f"Current version: {ver}")
    else:
        click.echo("‚ùå VERSION file not found")


@version.command("bump")
@click.option("--major", "component", flag_value="major", help="Bump major version (X.0.0)")
@click.option("--feature", "component", flag_value="feature", help="Bump feature version (x.X.0)")
@click.option("--bugfix", "component", flag_value="bugfix", default=True, help="Bump bugfix version (x.x.X)")
@click.option("--commit", is_flag=True, help="Commit the version bump")
def version_bump(component: str, commit: bool):
    """Bump version number."""
    app_root = get_app_root()
    version_file = app_root / "ops" / "build" / "VERSION"
    init_file = app_root / "{{ app_name }}" / "__init__.py"

    if not version_file.exists():
        click.echo("‚ùå VERSION file not found")
        sys.exit(1)

    current = version_file.read_text().strip()
    parts = current.split(".")

    if len(parts) != 3:
        click.echo(f"‚ùå Invalid version format: {current}")
        sys.exit(1)

    major, minor, patch = map(int, parts)

    if component == "major":
        new_version = f"{major + 1}.0.0"
    elif component == "feature":
        new_version = f"{major}.{minor + 1}.0"
    else:  # bugfix
        new_version = f"{major}.{minor}.{patch + 1}"

    click.echo(f"Bumping version: {current} ‚Üí {new_version}")

    # Update VERSION file
    version_file.write_text(new_version + "\n")
    click.echo(f"‚úì Updated {version_file}")

    # Update __init__.py if it exists
    if init_file.exists():
        content = init_file.read_text()
        new_content = re.sub(
            r'__version__\s*=\s*"[0-9]+\.[0-9]+\.[0-9]+"',
            f'__version__ = "{new_version}"',
            content
        )
        init_file.write_text(new_content)
        click.echo(f"‚úì Updated {init_file}")

    if commit:
        subprocess.run(["git", "add", str(version_file), str(init_file)], cwd=app_root)
        subprocess.run(["git", "commit", "-m", f"chore: Bump version to {new_version}"], cwd=app_root)
        click.echo("‚úì Committed version bump")


# =============================================================================
# Test Commands
# =============================================================================

@ops.command("test")
@click.option("--app", "app_name", help="Run tests for a specific app")
@click.option("--module", help="Run tests for a specific module")
@click.option("--doctype", help="Run tests for a specific doctype")
@click.option("--test", "test_name", help="Run a specific test function")
@click.option("--section", help="Run tests for a specific section")
@click.option("--continue-on-error", is_flag=True, help="Continue running tests after failures")
@click.option("--site", default="test_{{ app_name }}_site", help="Test site name")
def test_cmd(app_name, module, doctype, test_name, section, continue_on_error, site):
    """Run tests."""
    bench_root = get_bench_root()

    # Ensure site name starts with test_
    if not site.startswith("test_"):
        site = f"test_{site}"

    cmd = ["bench", "--site", site, "run-iq-tests"]

    if app_name:
        cmd.extend(["--app", app_name])
    if module:
        cmd.extend(["--module", module])
    if doctype:
        cmd.extend(["--doctype", doctype])
    if test_name:
        cmd.extend(["--test", test_name])
    if section:
        cmd.extend(["--section", section])
    if continue_on_error:
        cmd.append("--continue-on-error")

    click.echo(f"Running: {' '.join(cmd)}")
    result = subprocess.run(cmd, cwd=bench_root)
    sys.exit(result.returncode)


# =============================================================================
# Release Commands
# =============================================================================

@ops.group()
def release():
    """Release environment management."""
    pass


@release.command("run")
@click.option("--env-file", type=click.Path(exists=True), help="Path to custom .env file")
def release_run(env_file):
    """Start release environment."""
    app_root = get_app_root()
    script = app_root / "ops" / "scripts" / "release" / "run_release_helper.sh"

    cmd = ["bash", str(script)]
    if env_file:
        cmd.append(env_file)

    click.echo("Starting release environment...")
    result = subprocess.run(cmd, cwd=app_root)
    sys.exit(result.returncode)


@release.command("stop")
def release_stop():
    """Stop release environment."""
    app_root = get_app_root()
    script = app_root / "ops" / "scripts" / "release" / "stop_release_helper.sh"

    click.echo("Stopping release environment...")
    result = subprocess.run(["bash", str(script)], cwd=app_root)
    sys.exit(result.returncode)


@release.command("clean")
def release_clean():
    """Clean up release environment (remove containers and volumes)."""
    app_root = get_app_root()
    script = app_root / "ops" / "scripts" / "release" / "clean_release_helper.sh"

    click.echo("Cleaning release environment...")
    result = subprocess.run(["bash", str(script)], cwd=app_root)
    sys.exit(result.returncode)


# =============================================================================
# Build Commands (wrapper for baker-cli)
# =============================================================================

@ops.group()
def build():
    """Build commands (wrapper for baker-cli)."""
    pass


@build.command("plan")
def build_plan():
    """Show build plan (baker plan)."""
    app_root = get_app_root()
    settings = app_root / "ops" / "build" / "build-settings.yml"

    cmd = ["baker", "plan", "--settings", str(settings)]
    result = subprocess.run(cmd, cwd=app_root)
    sys.exit(result.returncode)


@build.command("images")
@click.option("--targets", multiple=True, help="Specific targets to build")
@click.option("--push", is_flag=True, help="Push images after building")
@click.option("--force", is_flag=True, help="Force rebuild")
def build_images(targets, push, force):
    """Build Docker images (baker build)."""
    app_root = get_app_root()
    settings = app_root / "ops" / "build" / "build-settings.yml"

    cmd = ["baker", "build", "--settings", str(settings)]

    if targets:
        cmd.extend(["--targets", ",".join(targets)])
    if push:
        cmd.append("--push")
    if force:
        cmd.append("--force")

    result = subprocess.run(cmd, cwd=app_root)
    sys.exit(result.returncode)


# =============================================================================
# Export commands for Frappe
# =============================================================================

commands = [ops]
